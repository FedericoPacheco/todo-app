# Source: https://www.endpointdev.com/blog/2024/06/docker-nginx-acme/

# Install acme.sh
# curl https://get.acme.sh | sh -s email=federico.ignacio.pacheco.pilan@gmail.com
# Close and reopen terminal or run: source ~/.bashrc

# Set Let's Encrypt as CA
# acme.sh --set-default-ca --server letsencrypt

# Create deploy subdirectories for nginx
# mkdir -p ~/deploy/nginx/html
# mkdir -p ~/deploy/nginx/ssl

# Copy file contents to container
# nano ~/deploy/nginx/html/index.html
# nano ~/deploy/docker-compose.prod.yaml
# nano ~/deploy/nginx/nginx.conf

# Start nginx first (needed for webroot validation)
# sudo docker compose -f docker-compose.prod.yaml up -d

# Issue certificate for todo subdomain
# acme.sh --issue -d todo.federicopacheco.dev -w ~/deploy/nginx/html --keylength 4096

# Install certificate and set auto-reload
# acme.sh --install-cert -d todo.federicopacheco.dev --key-file ~/deploy/nginx/ssl/key.pem --fullchain-file ~/deploy/nginx/ssl/cert.pem --reloadcmd "sudo docker exec nginx-server nginx -s reload"

# After updating nginx.conf with SSL config and uncommenting port 443 ssl volume, restart:
# sudo docker compose -f docker-compose.prod.yaml down
# sudo docker compose -f docker-compose.prod.yaml up -d

# Troubleshooting:
# Check config is valid: sudo docker exec nginx-server nginx -t
# Check logs: sudo docker compose -f docker-compose.prod.yaml logs nginx
# Verify certificate files exist in the container: sudo docker exec nginx-server ls -la /etc/nginx/ssl/

services:
  nginx:
    image: nginx:1.28.0-alpine
    container_name: nginx-server
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/html:/usr/share/nginx/html:ro
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    restart: unless-stopped