@startuml C4_Deployment
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Deployment.puml

Deployment_Node(user_device, "User's Device", "Windows/Mac/Linux/Mobile") {
    Deployment_Node(browser, "Web Browser", "Chrome/Firefox/Safari/Edge") {
        Container(spa, "ToDoApp SPA")
    }
}

Deployment_Node(porkbun, "Porkbun DNS", "DNS Provider") {
    Container(dns, "DNS A Record", "DNS", "Maps todo.federicopacheco.dev to server IP")
}

Deployment_Node(aws, "AWS Lightsail", "Ubuntu 24.04 LTS") {
    Deployment_Node(docker, "Docker Engine", "Docker 28.5.1, Compose 2.40.2") {
        Deployment_Node(docker_network_front, "todo-net", "Docker Bridge Network") {
            Deployment_Node(nginx_container, "todo-nginx", "Docker Container") {
                Container(nginx, "Nginx Web Server", "Nginx 1.28.0-alpine")
                Container(ssl_certs, "SSL Certificates", "Let's Encrypt", "4096-bit TLS certificates")
            }
            
            Deployment_Node(api_container, "todo-sails-app", "Docker Container") {
                Container(api, "API Application", "Sails.js 1.5.13")
            }
        }
        
        Deployment_Node(docker_network_back, "todo-back-net", "Docker Bridge Network") {
            Deployment_Node(db_container, "todo-postgres-db", "Docker Container") {
                ContainerDb(db, "PostgreSQL Database", "PostgreSQL 12.21", "Stores users and ToDos")
            }
            
            Deployment_Node(redis_container, "todo-redis", "Docker Container") {
                ContainerDb(session, "Session Store", "Redis 7.4.1-alpine", "Stores session data")
            }
        }
    }
    
    Deployment_Node(filesystem, "Host Filesystem", "Ubuntu") {
        Container(repo, "Code repository", "Git")
        Container(acme, "acme.sh", "Shell Script")
    }
}

Deployment_Node(github, "GitHub", "Cloud") {
    Container(actions, "GitHub Actions", "CI/CD Pipeline")
    Container(secrets, "GitHub Secrets", "Secret Store", "Stores production environment variables")
}

Rel(user_device, dns, "Resolves domain", "DNS")
Rel(dns, nginx, "Returns IP address", "DNS")
Rel(spa, nginx, "Makes API calls", "HTTPS (443)")
Rel(nginx, api, "Forwards API requests", "HTTP (1337)")
Rel(nginx, ssl_certs, "Uses for TLS", "File system")
Rel(api, db, "Reads/writes data", "SQL/TCP (5432)")
Rel(api, session, "Reads/writes sessions", "Redis protocol (6379)")

Rel(actions, repo, "Pulls code via SSH", "Git/SSH (22)")
Rel(actions, nginx, "Uploads static files via SCP", "SCP/SSH (22)")
Rel(actions, api_container, "Rebuilds and restarts", "Docker Compose/SSH")
Rel(secrets, actions, "Provides env vars", "GitHub API")

Rel(acme, ssl_certs, "Issues and renews certificates", "ACME protocol")
Rel(acme, nginx, "Reloads config after renewal", "Docker exec")

@enduml