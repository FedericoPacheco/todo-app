name: CD-main

on:
  push:
    branches: [main]
jobs:
  deploy-frontend:
    uses: ./.github/workflows/deploy-frontend.yaml
    with:
      mode: 'deploy'
    secrets:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

  deploy-backend:
    runs-on: ubuntu-latest
    needs: deploy-frontend
    steps:
      # https://github.com/marketplace/actions/ssh-remote-commands
      - name: SSH to server and run deploy script
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }} 
          key: ${{ secrets.SSH_PRIVATE_KEY }} 
          script: |
            cd ~/todo-app/deploy
            # Discard any local changes
            git checkout -- . 
            git checkout main
            git pull
            git log --oneline -1
            
            chmod +x doBackup.sh
            DATABASE_USER=${{ secrets.DATABASE_USER }} \
            DATABASE_PASSWORD='${{ secrets.DATABASE_PASSWORD }}' \
            DATABASE_NAME=${{ secrets.DATABASE_NAME }} \
            SESSION_PASSWORD='${{ secrets.SESSION_PASSWORD }}' \
            SESSION_SECRET=${{ secrets.SESSION_SECRET }} \
            bash doBackup.sh

            chmod +x doDeploy.sh
            DATABASE_USER=${{ secrets.DATABASE_USER }} \
            DATABASE_PASSWORD='${{ secrets.DATABASE_PASSWORD }}' \
            DATABASE_NAME=${{ secrets.DATABASE_NAME }} \
            SESSION_PASSWORD='${{ secrets.SESSION_PASSWORD }}' \
            SESSION_SECRET=${{ secrets.SESSION_SECRET }} \
            bash doDeploy.sh

      - name: Run smoke tests
        run: |
          curl --fail --silent --max-time 15 https://todo.federicopacheco.dev/api/health
          curl --fail --silent --max-time 15 https://todo.federicopacheco.dev

      # - name: Fail on purpose to trigger rollback
      #   run: exit 1

      - name: Deployment successful
        if: success()
        run: echo "Deployment to production completed successfully"
        
      - name: Deployment failed
        if: failure()
        run: echo "Deployment to production failed, initiating rollback"

  rollback-frontend:
    needs: deploy-backend
    if: ${{ always() && needs.deploy-backend.result == 'failure' }}
    uses: ./.github/workflows/deploy-frontend.yaml
    with:
      mode: 'rollback'
    secrets:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

  rollback-backend:
    needs: rollback-frontend
    if: ${{ always() && needs.rollback-frontend.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Rollback db and lift services on server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }} 
          key: ${{ secrets.SSH_PRIVATE_KEY }} 
          script: |
            cd ~/todo-app/deploy
            git checkout HEAD~1
            git log --oneline -1
            
            chmod +x doRestore.sh
            DATABASE_USER=${{ secrets.DATABASE_USER }} \
            DATABASE_PASSWORD='${{ secrets.DATABASE_PASSWORD }}' \
            DATABASE_NAME=${{ secrets.DATABASE_NAME }} \
            SESSION_PASSWORD='${{ secrets.SESSION_PASSWORD }}' \
            SESSION_SECRET=${{ secrets.SESSION_SECRET }} \
            bash doRestore.sh

            chmod +x doDeploy.sh
            DATABASE_USER=${{ secrets.DATABASE_USER }} \
            DATABASE_PASSWORD='${{ secrets.DATABASE_PASSWORD }}' \
            DATABASE_NAME=${{ secrets.DATABASE_NAME }} \
            SESSION_PASSWORD='${{ secrets.SESSION_PASSWORD }}' \
            SESSION_SECRET=${{ secrets.SESSION_SECRET }} \
            bash doDeploy.sh

      - name: Run smoke tests on rollback
        run: |
          curl --fail --silent --max-time 15 https://todo.federicopacheco.dev/api/health
          curl --fail --silent --max-time 15 https://todo.federicopacheco.dev
          echo "Rollback completed successfully"

      - name: Rollback failed
        if: failure()
        run: echo "CRITICAL. Rollback failed, manual intervention required!"
          
# Secrets:
# https://nektosact.com/usage/index.html#secrets
# https://sanjulaganepola.github.io/github-local-actions-docs/usage/settings/#secrets